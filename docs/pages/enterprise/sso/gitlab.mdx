---
title: Authentication With GitLab as an SSO provider
description: How to configure Teleport access using GitLab for SSO.
h1: Teleport SSO Authentication with GitLab
---

## How to use GitLab as a single sign-on (SSO) provider with Teleport

This guide will cover how to configure [GitLab](https://www.gitlab.com/) to issue
SSH credentials to specific groups of users. When used in combination with Role-Based Access Control (RBAC), it allows administrators to define policies
like:

- Only members of "DBA" group can SSH into machines running PostgreSQL.
- Only members of "ProductionKubernetes" can access production Kubernetes clusters
- Developers must never SSH into production servers.

<Admonition
  type="warning"
  title="Version Warning"
>
  This guide requires a commercial edition of Teleport. The open source
  edition of Teleport only supports [Github](../../admin-guide.mdx#github-oauth-20) as
  an SSO provider.
</Admonition>

## Enable OIDC Authentication

First, configure the Teleport auth server to use OIDC authentication instead of the local
user database. Update `/etc/teleport.yaml` as shown below and restart the
teleport daemon.

```yaml
auth_service:
    authentication:
        type: oidc
```

## Configure GitLab

You should have at least one group configured in GitLab to map to Teleport roles. In this example, we use the names `gitlab-dev` and `gitlab-admin`.  Assign users to each of these groups.

1. Create an Application in one of your Groups that will allow using GitLab as a OAuh provider to Teleport.

Settings

- Redirect URL `https://<proxy url>/v1/webapi/oidc/callback` such as `https://teleport.example.com:3080/v1/webapi/oidc/callback`
- Check `Confidential`, `openid`, `profile`, and `email`.

![Create App](../../../img/sso/gitlab/gitlab-oidc-0.png)

2. Collect the `Application ID` and `Secret` in the Application

These will be used in the Teleport OIDC Auth Connector.

![Collection Information](../../../img/sso/gitlab/gitlab-oidc-1.png)

3. Confirm the GitLab Issuer Address

For GitLab cloud that is `https://gitlab.com`. That allows accessing the Open-ID configuration at `https://gitlab.com/.well-known/openid-configuration`.
If you are self-hosting that is likely another local address.

## Configure Teleport

### Create a OIDC Connector

Create a OIDC connector [resource](../../admin-guide.mdx#resources):
Replace the Application ID and the Secret with the values from GitLab.

```yaml
kind: oidc
metadata:
  name: gitlab
spec:
  claims_to_roles:
  - claim: groups
    roles:
    - admin
    value: gitlab-admin
  - claim: groups
    roles:
    - admin
    value: gitlab-dev
  client_id: Application_ID
  client_secret: Secret
  display: GitLab
  issuer_url: https://gitlab.com
  prompt: ""
  redirect_url: https://teleport.example.com:3080/v1/webapi/oidc/callback
  scope:
  - email
version: v2
```

<Admonition
  type="note"
  title="IMPORTANT"
>
  The `prompt` value must be blank.  Setting to blank means Teleport will not send this as a parameter sending the `select_account` parameter will result in an error from GitLab.
</Admonition>

(!docs/pages/includes/permission-warning.mdx!)

Create the connector using `tctl` tool:

```bash
tctl create oidc-connector.yaml
```

## Create Teleport Roles

We are going to create two roles, privileged role admin who can log in as
root and is capable of administrating the cluster and non-privileged dev.

```yaml
kind: role
version: v3
metadata:
  name: admin
spec:
  options:
    max_session_ttl: 24h
  allow:
    logins: [root]
    node_labels:
      "*": "*"
    rules:
      - resources: ["*"]
        verbs: ["*"]
```

The developer role:

```yaml
kind: role
version: v3
metadata:
  name: dev
spec:
  options:
    max_session_ttl: 24h
  allow:
    logins: [ "{{email.local(external.email)}}", ubuntu ]
    node_labels:
      access: relaxed
```

- Devs are only allowed to log in to nodes labeled with the `access: relaxed` label.
- Developers can log in as `ubuntu` user
- Notice `{{external.email}}` login. It configures Teleport to look at
  *"email"* GitLab claim and use that field as an allowed login for each user.  The `email.local(external.trait)` function will remove the `@domain` and just have the username prefix.
- Developers also do not have any "allow rules" i.e. they will not be able to see or replay past sessions or re-configure the Teleport cluster.

Create both roles on the auth server:

```bash
tctl create admin.yaml
tctl create dev.yaml
```

## Testing

The Web UI will now contain a new button: "Login with GitLab". The CLI is
the same as before:

```bash
tsh --proxy=teleport.example.com login
```

This command will print the SSO login URL (and will try to open it
automatically in a browser).

<Admonition
  type="tip"
  title="Tip"
>
  Teleport can use multiple OIDC/SAML connectors. In this case a connector name
  can be passed via `tsh login --auth=connector_name`
</Admonition>

<Admonition
  type="note"
  title="IMPORTANT"
>
  Teleport only supports sending party-initiated flows for OIDC Connect. This means you can not initiate login from your identity provider, you have to initiate login from either the Teleport Web UI or CLI.
</Admonition>

## Troubleshooting

If you get "access denied errors" the number one place to check is the events in the audit
log on the Teleport auth server. The audit events log is located in `/var/lib/teleport/log/events.log` by
default and it will contain the detailed reason why a user's login was denied.

Some errors (like filesystem permissions or misconfigured network) can be
diagnosed using Teleport's `stderr` log, which is usually available via:

```bash
journalctl -fu teleport
```

If you wish to increase the verbosity of Teleport's syslog, you can pass
`--debug` flag to `teleport start` command.